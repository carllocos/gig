{% extends "gig/base.html" %}
{% load static %}
{% load cloudinary %}


{% block title %}
{{band.name}}
{% endblock %}

{% block body %}
<div class="container">

  <div class="row">
    <div class="col-12">
    </div>
  </div>




  <div class="row">
    <div class="col-12">
      <h1>
        {{band.name}}
      </h1>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <h2>
        Band Profile Picture
      </h2>
      {% cloudinary band.profile_pic.public_id width=100 height=150 crop="fill"%}
    </div>
    {% if is_owner %}
    <div class="col-12">
      <input type="file" name="profile_pic" accept="image/*" id="id_profile_pic">
      <button type="button" name="button_update_profile_pic" onClick="updateProfilePic('id_profile_pic')">Save new Profile pic</button>
    </div>
    {% endif %}
  </div>

  <div class="row">
    <div class="col-12">
      <h2>
        Background Picture
      </h2>
      {% cloudinary band.background_pic.public_id width=100 height=150 crop="fill"%}
    </div>
    {% if is_owner %}
    <div class="col-12">
      <input type="file" name="backgr_pic" accept="image/*" id="id_background_pic">
      <button type="button" name="button_update_backgroun_pic" onClick="updateBackgroundPic('id_background_pic')">Save new bg pic</button>
    </div>
    {% endif %}
  </div>


  <div class="row">
    <div class="col-12">
      <h2>
        Band description
      </h2>
      {% if is_owner %}
      <textarea name="description"id='id_description' rows="8" cols="80">{{band.description}}</textarea>
      {% else %}
      <p>
        {{band.description}}
      </p>
      {% endif %}
    </div>
    {% if is_owner %}
    <div class="col-12">
      <button type="button" name="button_update_description" onClick="updateDescription('id_description')">Update Description</button>
    </div>
    {% endif %}

  </div>

  {% if band.genres %}
  {% if is_owner %}
  <div class="row">
    <h2>Band Genres</h2>
    <div class="col-12">
      {% for genre in band.genres %}
      <input type="text" name="genre0" id="id_genre0" value="{{genre}}">
      <button type="button" name="" onClick="removeGenre('id_genre0')">Remove Genre</button>
      {% endfor %}
      <div class="genre-container">
        <input type="text" name="new_genre0" id="id_new_genre0" value="add genre">
        <button type="button" name="" onClick="addGenre('id_new_genre0')">Add Genre</button>
      </div>

    </div>
  </div>
  {% else %}

    <div class="row">
      <div class="col-12">
        <h2>Band Genres</h2>
        <ul>
          {% for genre in band.genres %}
          <li>
            {{genre}}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  {% else %}
  <div class="row">
    <h2>Band Genres</h2>
    {% if is_owner %}
    <div class="genre-container">
      <input type="text" name="new_genre0" id="id_new_genre0" value="add genre">
      <button type="button" name="" onClick="addGenre('id_new_genre0')">Add Genre</button>
    </div>
    {% else %}
    <div class="col-12">
      Band didn't specify any genre
    </div>
    {% endif %}
  </div>
  {% endif %}


  <div class="row">
    <div class="col-12">
      <h2>
        Pictures
      </h2>
      <p>
        Pictures roll come here
      </p>
    </div>
  </div>


  <div class="row">
    <div class="col-12">
      <h2>
        videos
      </h2>
      <p>
        Video roll comes here
      </p>
    </div>
  </div>




  <div class="row">
    <div class="col-12">
      <h2>Linup</h2>
      <ul>
        {% for member in line_up %}
        <li>
          <a href="{% url 'artists:artist-profile' profile_id=member.artist.pk%}">{{member.artist.stage_name}}</a>
          <br>
          {% if is_owner%}
          <input type="text" name="role" id="id_role0" value="{{member.role}}">
          <button type="button" name="" onClick="updateRole('id_role0', '{{member.pk}}')">Update Role</button>
          <button type="button" name="" onClick="removeMember('id_role0', '{{member.pk}}')">Remove member</button>
          {% else %}
          <p>{{member.role}}</p>
          {% endif %}
          <br>
          (profile public_id {{member.artist.profile_pic.public_id}})
          {% cloudinary member.artist.profile_pic.public_id width=100 height=150 crop="fill"%}
        </li>
        {% endfor %}
        {% if is_owner %}
        <li>
          <input type="email" name="" id="id_new_member0" value="add member" required>
          <p id="id_info_text">Warning text</p>
          <button type="button" name="" onClick="addMember('id_new_member0', 'id_info_text')">Send invitation</button>
        </li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>


<script type="text/javascript">

function sendAjaxRequest(url_l, dict, valToSend){
  if (valToSend != ''){
    alert(`sendAjaxRequest with value ${valToSend}`);
    $.ajax({
      type: "POST",
      url: url_l,
      data: dict,
      dataType: 'json',
      success: function(response){

        if(response.is_executed){
          alert(`backend performed the requested operation succesfuly involving ${response.val}`)
        }
        else{
          alert(`backend couldn't perform the requested operation reason: ${response.reason}`)
        }

      }});

    }else {
      alert("AjaxRequest wasn't send. The value involved in the update is an empty string ");
    }
  }

  function updateProfilePic(id_selector){

  }

  function updateBackgroundPic(id_selector) {

  }

  function updateDescription(id_selector) {
    $des=$(`#${id_selector}`);
    var dict= {
      'val': $des.val(),
      'band_id': {{band.pk}},
      csrfmiddlewaretoken: '{{ csrf_token }}',
    };

    sendAjaxRequest("{% url 'musicians:update-description' %}", dict, $des.val());
  }

  function operationGenre(id_selector, operation){
    $des=$(`#${id_selector}`);
    var dict= {
      'val': $des.val(),
      'operation': operation,
      'band_id': {{band.pk}},
      csrfmiddlewaretoken: '{{ csrf_token }}',
    };

    sendAjaxRequest("{% url 'musicians:update-genre' %}", dict, $des.val());
  }

  function addGenre(id_selector){
    operationGenre(id_selector, 'add');
  }
  function removeGenre(id_selector){
    operationGenre(id_selector, 'remove');
  }


  function operationMember(id_selector, member_id, operation){
    $des=$(`#${id_selector}`);
    var dict= {
      'val': $des.val(),
      'operation': operation,
      'member_id': member_id,
      'band_id': {{band.pk}},
      csrfmiddlewaretoken: '{{ csrf_token }}',
    };

    sendAjaxRequest("{% url 'musicians:update-member' %}", dict, $des.val());
  }

  function updateRole(id_selector, member_id){
    operationMember(id_selector, member_id, 'update');
  }


  function removeMember(id_selector, member_id){
    operationMember(id_selector, member_id, 'remove');
  }

  function addMember(id_selector, id_help_text) {
    $des=$(`#${id_selector}`);
    var dict= {
      'val': $des.val(),
      'url': "{% url 'musicians:add-member' %}",
      'band_id': {{band.pk}},
      csrfmiddlewaretoken: '{{ csrf_token }}',
    };

    var valToSend=$des.val();
    var url_l= "{% url 'musicians:add-member' %}";

    if (valToSend != ''){
      alert(`sendAjaxRequest with value ${valToSend}`);
      $.ajax({
        type: "POST",
        url: url_l,
        data: dict,
        dataType: 'json',
        success: function(response){
          $helptext=$(`#${id_help_text}`);
          if(response.is_executed){
            $helptext.text('An invitation was send succesfuly');
          }
          else{
            alert(`backend couldn't perform the requested operation reason: ${response.reason}`);
            $helptext.text(response.reason);
          }

        }});

      }else {
        alert("AjaxRequest wasn't send. The value involved in the update is an empty string ");
      }
  }

</script>
{% endblock %}
